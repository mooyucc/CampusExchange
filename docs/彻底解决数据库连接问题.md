# 🔧 彻底解决数据库连接问题

## 当前问题
两个端口都无法连接：
- ❌ 端口 6543（连接池）→ 无法连接
- ❌ 端口 5432（直接连接）→ 无法连接

## 系统性排查方案

### 步骤 1：在 Supabase 中获取正确的连接字符串

1. **访问 Supabase Dashboard**
   - https://supabase.com/dashboard
   - 选择您的项目

2. **获取连接字符串**
   - Settings → Database
   - 找到 **Connection string** 部分
   - 选择 **URI** 标签
   - **复制完整的连接字符串**
   - **确保替换 `[YOUR-PASSWORD]` 为 `SbMooyu123`**

### 步骤 2：检查 Supabase 网络设置

在 Supabase Settings → Database 中：

1. **检查 Network Restrictions**
   - 找到 "Network Restrictions" 或 "IP Whitelist"
   - 确保设置为 "Allow all IPs" 或添加 Vercel 的 IP 范围

2. **检查 Connection Pooling**
   - 如果使用连接池（6543），确认已启用
   - 如果未启用，使用直接连接（5432）

### 步骤 3：测试连接字符串

在 Supabase SQL Editor 中测试：

1. 打开 **SQL Editor**
2. 创建一个测试查询，使用实际的连接信息：
   ```sql
   -- 这只是一个测试，确认数据库可访问
   SELECT current_database(), current_user;
   ```
3. 如果这个查询成功，说明数据库本身正常

### 步骤 4：验证环境变量格式

确保 `DATABASE_URL` 的格式完全正确：

**标准格式：**
```
postgresql://[用户名]:[密码]@[主机]:[端口]/[数据库名]
```

**您的应该是：**
```
postgresql://postgres:SbMooyu123@db.amqaeolouwkpsqndrubk.supabase.co:5432/postgres
```

**检查要点：**
- ✅ 没有多余的空格
- ✅ 密码正确（`SbMooyu123`，M 大写）
- ✅ 主机名正确
- ✅ 端口正确
- ✅ 数据库名是 `postgres`

### 步骤 5：尝试 Supabase 提供的连接字符串

在 Supabase Settings → Database 中：

1. 找到 **Connection string** 部分
2. 选择 **Transaction** 模式（不是 Session）
3. 复制连接字符串
4. 将密码替换为 `SbMooyu123`
5. 在 Vercel 中更新 `DATABASE_URL`

---

## 备选方案

### 方案 A：检查是否有项目暂停

在 Supabase Dashboard：
- 查看项目状态
- 如果显示 "Paused"，点击 "Resume" 恢复

### 方案 B：使用 Supabase 的 Session 模式连接字符串

在 Supabase Settings → Database：
- 选择 **Session** 模式的连接字符串（不是 Transaction）
- 可能是不同的端口或格式

### 方案 C：检查防火墙/安全组

在 Supabase Settings → Database：
- 检查是否有额外的安全设置
- 确保允许来自外部的连接

---

## 立即行动

1. **在 Supabase 中：**
   - Settings → Database
   - 复制完整的 Connection string（URI 格式）
   - 确认密码部分替换为 `SbMooyu123`

2. **在 Vercel 中：**
   - 使用从 Supabase 复制的连接字符串
   - 确保完全一致（包括端口、参数等）

3. **保存并重新部署**

---

## 如果仍然不行

可能需要：
1. 联系 Supabase 支持
2. 检查是否有防火墙阻止
3. 验证数据库是否真的在线（虽然显示 Healthy）

**请先按照步骤 1，从 Supabase 中复制官方的连接字符串，然后告诉我具体的连接字符串格式。**

