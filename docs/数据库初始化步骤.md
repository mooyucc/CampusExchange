# 📋 数据库初始化 - 详细步骤

## 🎯 目标
在 Supabase 数据库中创建三个表：`User`、`Item`、`ExchangeRequest`

---

## 📝 详细操作步骤

### 步骤 1：访问 Supabase
1. 打开浏览器
2. 访问：https://supabase.com/dashboard
3. 使用您的账号登录
4. 在项目列表中找到您的项目（应该是那个包含 `amqaeolouwkpsqndrubk` 的项目）

### 步骤 2：打开 SQL Editor
1. 在左侧菜单中，找到 **SQL Editor**（图标是一个数据库表格）
   - 如果菜单折叠了，点击左上角的三条横线展开
2. 点击 **SQL Editor**
3. 在右侧，点击 **New query**（新建查询）按钮

### 步骤 3：复制 SQL 脚本
**在您的项目中：**
- 打开文件：`prisma/init-database.sql`
- **全选**（`Ctrl+A` 或 `Cmd+A`）
- **复制**（`Ctrl+C` 或 `Cmd+C`）

**或者直接复制下面的内容：**

```sql
-- 创建 User 表
CREATE TABLE IF NOT EXISTS "User" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "grade" TEXT,
    "avatar" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- 创建唯一索引
CREATE UNIQUE INDEX IF NOT EXISTS "User_email_key" ON "User"("email");

-- 创建 Item 表
CREATE TABLE IF NOT EXISTS "Item" (
    "id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT NOT NULL,
    "category" TEXT NOT NULL,
    "condition" TEXT NOT NULL,
    "images" TEXT NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'available',
    "ownerId" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "Item_pkey" PRIMARY KEY ("id")
);

-- 创建索引
CREATE INDEX IF NOT EXISTS "Item_ownerId_idx" ON "Item"("ownerId");

-- 创建外键约束
ALTER TABLE "Item" 
ADD CONSTRAINT IF NOT EXISTS "Item_ownerId_fkey" 
FOREIGN KEY ("ownerId") 
REFERENCES "User"("id") 
ON DELETE CASCADE 
ON UPDATE CASCADE;

-- 创建 ExchangeRequest 表
CREATE TABLE IF NOT EXISTS "ExchangeRequest" (
    "id" TEXT NOT NULL,
    "requesterId" TEXT NOT NULL,
    "receiverId" TEXT NOT NULL,
    "itemId" TEXT NOT NULL,
    "message" TEXT,
    "status" TEXT NOT NULL DEFAULT 'pending',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "ExchangeRequest_pkey" PRIMARY KEY ("id")
);

-- 创建索引
CREATE INDEX IF NOT EXISTS "ExchangeRequest_requesterId_idx" ON "ExchangeRequest"("requesterId");
CREATE INDEX IF NOT EXISTS "ExchangeRequest_receiverId_idx" ON "ExchangeRequest"("receiverId");
CREATE INDEX IF NOT EXISTS "ExchangeRequest_itemId_idx" ON "ExchangeRequest"("itemId");

-- 创建外键约束
ALTER TABLE "ExchangeRequest" 
ADD CONSTRAINT IF NOT EXISTS "ExchangeRequest_requesterId_fkey" 
FOREIGN KEY ("requesterId") 
REFERENCES "User"("id") 
ON DELETE CASCADE 
ON UPDATE CASCADE;

ALTER TABLE "ExchangeRequest" 
ADD CONSTRAINT IF NOT EXISTS "ExchangeRequest_receiverId_fkey" 
FOREIGN KEY ("receiverId") 
REFERENCES "User"("id") 
ON DELETE CASCADE 
ON UPDATE CASCADE;

ALTER TABLE "ExchangeRequest" 
ADD CONSTRAINT IF NOT EXISTS "ExchangeRequest_itemId_fkey" 
FOREIGN KEY ("itemId") 
REFERENCES "Item"("id") 
ON DELETE CASCADE 
ON UPDATE CASCADE;
```

### 步骤 4：粘贴并运行 SQL
1. 在 Supabase SQL Editor 的编辑框中，**粘贴**刚才复制的 SQL（`Ctrl+V` 或 `Cmd+V`）
2. 点击右上角的 **Run** 按钮
   - 或者按快捷键：`Ctrl + Enter`（Windows）或 `Cmd + Enter`（Mac）

### 步骤 5：查看执行结果
1. 执行后，在底部会显示执行结果
2. 如果成功，会显示类似：`Success. No rows returned`
3. 如果有错误，会显示具体的错误信息

### 步骤 6：验证表是否创建成功
1. 在左侧菜单中，点击 **Table Editor**（表格图标）
2. 您应该能看到三个表：
   - ✅ **User**
   - ✅ **Item**
   - ✅ **ExchangeRequest**

---

## ✅ 完成后的验证

### 1. 在 Supabase 中验证
- [ ] 能看到三个表（User, Item, ExchangeRequest）
- [ ] 每个表都有对应的列（字段）

### 2. 在 Vercel 应用中验证
1. 等待 1-2 分钟
2. 访问：https://campus-exchange-theta.vercel.app
3. 如果页面能正常打开（不再显示错误），说明成功！

---

## ⚠️ 常见问题

### 问题 1：找不到 SQL Editor
- **解决：** 确保您已登录 Supabase
- **解决：** 确保已选择正确的项目

### 问题 2：执行 SQL 时出错
**错误："relation already exists"**
- **解决：** 这表示表已存在，可以忽略，或先删除再创建

**其他错误：**
- 复制我提供的确切 SQL 语句
- 确保没有遗漏任何部分

### 问题 3：看不到新创建的表
- **解决：** 刷新 Table Editor 页面
- **解决：** 确认您选择了正确的项目

---

## 🎉 完成后

数据库初始化完成后：
1. ✅ 应用错误率应该降为 0%
2. ✅ 可以访问网站首页
3. ✅ 可以注册新用户
4. ✅ 可以发布物品

**现在开始操作吧！** 按照上面的步骤在 Supabase 中运行 SQL 脚本。

